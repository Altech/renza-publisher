#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$:.unshift File.expand_path('../lib', __dir__)

require 'renza-publisher'
require 'renza-publisher/image-processor'
require 'renza-publisher/path'

require 'fileutils'
require 'optparse'
require 'time'
require 'pp'
require 'json'

require 'colorize'


include FileUtils

begin
  input = Hash.new

  opt = OptionParser.new("使い方: renza-publisher-split -l <location> -t <time> [-d <disk-number>] <video-file>+")
  opt.on('-l LOCATION','--location', '動画が撮影された場所. e.g. 秋葉原レジャーランド') {|s| input[:location] = s}
  opt.on('-t TIME','--time', '動画が撮影された日時. e.g. "2012-10-03 15:00:00"') {|d| input[:time] = Time.parse(d)} 
  opt.on('-d NUMBER','--disk-number', '特定のディスクを処理する場合のディスク番号（1始まり）'){|n| input[:disk_number] = n.to_i if n}
  opt.parse!(ARGV)
  input[:videos] = ARGV.dup

  abort "撮影が行われた場所を-lオプションで指定してください" if input[:location].nil?
  abort "撮影が行われた日時を-tオプションで指定してください" if input[:time].nil?
  abort "動画ファイルを指定してください" if input[:videos].nil? or input[:videos].empty?
  abort "指定したファイルは存在しません" if not input[:videos].all?{|file| File.exists? file}
  abort "ディスクナンバーはファイルが一つの時に指定してください" if ARGV.size > 1 and input[:disk_number]
end

input[:videos].each_with_index do |src_video, disk_number_minus_one|
  disk_number = input[:disk_number] ? input[:disk_number] : disk_number_minus_one + 1
  output_dir  = "renza-#{input[:time].strftime("%Y-%m-%d")}"
  working_dir = output_dir + "/images-disk#{disk_number}"
  
  path = RenzaPublisher::Path.new(working_dir, output_dir, File.extname(src_video))

  # # 1. create images
  unless Dir.exists? working_dir and File.exists? path.image_file(1)
    puts "ffmpeg -i #{src_video} -r 1 -f image2 #{working_dir}/#{RenzaPublisher::Path::IMAGE_FORMAT}"
    puts `ffmpeg -i #{src_video} -r 1 -f image2 #{working_dir}/#{RenzaPublisher::Path::IMAGE_FORMAT}`
  end

  # # 2. choose sample images and mask them
  unless Dir.exists?(path.sample_dir) and path.sample_dir_include_all_samples?
    mkdir path.sample_dir unless Dir.exists?(path.sample_dir)
    puts "imagesディレクトリからサンプル画像を3つsamplesディレクトリにコピーしてください。"
    puts "そのあと、それぞれを #{path.sample_basenames.map{|s| s + ".jpg"}.join(', ')} にリネームしてください。"
    `open #{path.sample_dir}`; sleep 0.5; `open #{working_dir}`
    sleep 0.5 until path.sample_dir_include_all_samples?
    puts "サンプル画像を確認しました。"
  end
  samples = Hash[path.sample_basenames.map(&:to_sym).zip path.sample_files]
  RenzaPublisher::ImageProcessor.create_images_for_masking(path)

  # # 3. search begin-ends.
  unless File.exists? path.time_table_file(disk_number)
    result = Array.new
    i = 1
    loop do
      candidate = path.image_file(i)

      break if not File.exists? candidate
      
      if    RenzaPublisher::ImageProcessor.is_same?(samples[:beginning],   candidate, path.masking_file_for_beginning)
        puts "beginning: #{candidate}".blue
        result << [i]
        i += 70
      elsif RenzaPublisher::ImageProcessor.is_same?(samples[:ending_win],  candidate)
        puts "ending(win): #{candidate}".green
        result.last += [i,:win] if result.size > 0 and result.last.size == 1
        i += 10
      elsif RenzaPublisher::ImageProcessor.is_same?(samples[:ending_lose], candidate, path.masking_file_for_losing)
        puts "ending(lose): #{candidate}".green
        # 1秒前を指定
        result.last += [i-1,:lose] if result.size > 0 and result.last.size == 1
        i += 10
      else
        i += 1
      end
    end
    File.write(path.time_table_file(disk_number), result.to_json)
  end
  
  result = JSON.parse(File.read(path.time_table_file(disk_number)))

  # # 4. split the movie.
  base = (1..(disk_number-1)).map{|previous_disk_number|
    abort "#{previous_disk_number}番目のディスクを先に処理してください" if not File.exists? path.time_table_file(previous_disk_number)
    JSON.parse(File.read(path.time_table_file(previous_disk_number))).select{|a| a.size == 3}.size
  }.reduce(0,&:+)
  result.select{|a| a.size == 3}.each_with_index do |times, i|
    from, to, _ = times
    thumbnail = path.image_file(from+5)
    
    rm path.video_file(base+i+1) if File.exists? path.video_file(base+i+1)
    cp thumbnail, path.thumbnail_file(base+i+1)
    
    puts "ffmpeg -i \"#{src_video}\" -ss #{from-3} -t #{to-from+1} \"#{path.video_file(base+i+1)}\""
    puts `ffmpeg -i "#{src_video}"   -ss #{from-3} -t #{to-from+1}  "#{path.video_file(base+i+1)}"`

  end

  File.write(path.metadata_file, {location: input[:location], time: input[:time]}.to_json)
  
end
